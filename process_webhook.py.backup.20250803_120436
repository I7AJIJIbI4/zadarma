#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
process_webhook.py - –ü–û–ö–†–ê–©–ï–ù–ò–ô –æ–±—Ä–æ–±–Ω–∏–∫ webhook-—ñ–≤ –¥–ª—è —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó –∑ —Ç–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–æ–º
–í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∑ PHP webhook-–∞ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –ø–æ–¥—ñ–π Zadarma
"""

import sys
import json
import logging
import os
import time

# –î–æ–¥–∞—î–º–æ —à–ª—è—Ö –¥–æ –Ω–∞—à–æ–≥–æ –ø—Ä–æ–µ–∫—Ç—É
sys.path.append('/home/gomoncli/zadarma')

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('/home/gomoncli/zadarma/webhook_processor.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger('webhook_processor')

def main():
    """–ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –æ–±—Ä–æ–±–∫–∏ webhook"""
    try:
        # –û—Ç—Ä–∏–º—É—î–º–æ JSON –¥–∞–Ω–Ω—ñ –∑ –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ —Ä—è–¥–∫–∞
        if len(sys.argv) < 2:
            logger.error("‚ùå –ù–µ –ø–µ—Ä–µ–¥–∞–Ω–æ JSON –¥–∞–Ω–Ω—ñ")
            print(json.dumps({"success": False, "message": "No JSON data provided"}))
            sys.exit(1)
        
        json_data = sys.argv[1]
        logger.info(f"üì• –û—Ç—Ä–∏–º–∞–Ω–æ –¥–∞–Ω–Ω—ñ: {json_data}")
        
        # –ü–∞—Ä—Å–∏–º–æ JSON
        try:
            webhook_data = json.loads(json_data)
        except json.JSONDecodeError as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É JSON: {e}")
            print(json.dumps({"success": False, "message": f"JSON parse error: {e}"}))
            sys.exit(1)
        
        event = webhook_data.get('event', '')
        pbx_call_id = webhook_data.get('pbx_call_id', '')
        caller_id = webhook_data.get('caller_id', '').replace('+', '')
        disposition = webhook_data.get('disposition', '')
        duration = int(webhook_data.get('duration', 0))
        
        logger.info(f"üîî Webhook –ø–æ–¥—ñ—è: {event}, PBX ID: {pbx_call_id}, Caller: {caller_id}, Disposition: {disposition}")
        
        # –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –Ω–∞—à –º–æ–¥—É–ª—å webhook –æ–±—Ä–æ–±–∫–∏
        try:
            from zadarma_api_webhook import process_webhook_call_status, send_telegram_message, call_tracker
            logger.info("‚úÖ –£—Å–ø—ñ—à–Ω–æ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ zadarma_api_webhook")
        except ImportError as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É zadarma_api_webhook: {e}")
            # Fallback - –ø—Ä–æ–±—É—î–º–æ —ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –∑—ñ —Å—Ç–∞—Ä–æ–≥–æ –º–æ–¥—É–ª—è
            try:
                from zadarma_api import process_webhook_call_status, send_telegram_message, call_tracker
                logger.info("‚úÖ Fallback: —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ zadarma_api")
            except ImportError:
                logger.error("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è —ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –∂–æ–¥–Ω–∏–π –º–æ–¥—É–ª—å webhook –æ–±—Ä–æ–±–∫–∏")
                print(json.dumps({"success": False, "message": "Import error"}))
                sys.exit(1)
        
        # –û–±—Ä–æ–±–ª—è—î–º–æ —Ä—ñ–∑–Ω—ñ —Ç–∏–ø–∏ –ø–æ–¥—ñ–π
        if event == 'NOTIFY_END':
            logger.info(f"üìû –û–±—Ä–æ–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –¥–∑–≤—ñ–Ω–∫–∞: {caller_id} -> {disposition}")
            
            # –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –≤—ñ–¥—Å—Ç–µ–∂—É–≤–∞–Ω—ñ –¥–∑–≤—ñ–Ω–∫–∏
            call_data = None
            
            # –®—É–∫–∞—î–º–æ –ø–æ PBX ID
            if pbx_call_id:
                call_data = call_tracker.get_call_by_pbx_id(pbx_call_id)
                logger.info(f"üîç –ü–æ—à—É–∫ –ø–æ PBX ID {pbx_call_id}: {'–∑–Ω–∞–π–¥–µ–Ω–æ' if call_data else '–Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'}")
            
            # –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø–æ PBX ID, —à—É–∫–∞—î–º–æ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω—É
            if not call_data:
                # –ù–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É
                target_number = None
                if '0637442017' in caller_id:
                    target_number = '0637442017'
                elif '0930063585' in caller_id:
                    target_number = '0930063585'
                
                if target_number:
                    call_data = call_tracker.get_call_by_target_and_time(target_number, 120)
                    logger.info(f"üîç –ü–æ—à—É–∫ –ø–æ –Ω–æ–º–µ—Ä—É {target_number}: {'–∑–Ω–∞–π–¥–µ–Ω–æ' if call_data else '–Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'}")
            
            if call_data:
                logger.info(f"üìû –ó–Ω–∞–π–¥–µ–Ω–æ –≤—ñ–¥—Å—Ç–µ–∂—É–≤–∞–Ω–∏–π –¥–∑–≤—ñ–Ω–æ–∫: {call_data['call_id']}")
                
                action_name = "—Ö–≤—ñ—Ä—Ç–∫—É" if call_data['action_type'] == 'hvirtka' else "–≤–æ—Ä–æ—Ç–∞"
                chat_id = call_data['chat_id']
                
                # –î–µ—Ç–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –¥–∑–≤—ñ–Ω–∫–∞
                message = ""
                status = ""
                
                if disposition == 'cancel' and duration == 0:
                    # ‚úÖ –£–°–ü–Ü–•: –î–∑–≤—ñ–Ω–æ–∫ —Å–∫–∏–Ω—É—Ç–æ –ø—ñ—Å–ª—è –≥—É–¥–∫—ñ–≤ (—Å–∏—Å—Ç–µ–º–∞ –≤—ñ–¥–ø–æ–≤—ñ–ª–∞ —ñ —Å–∫–∏–Ω—É–ª–∞)
                    message = f"‚úÖ {action_name.capitalize()} –≤—ñ–¥—á–∏–Ω–µ–Ω–æ!"
                    status = 'success'
                    logger.info(f"‚úÖ SUCCESS: {action_name} –≤—ñ–¥–∫—Ä–∏—Ç–æ —É—Å–ø—ñ—à–Ω–æ (cancel + 0 duration)")
                    
                elif disposition == 'busy':
                    # ‚ùå –ó–ê–ô–ù–Ø–¢–û  
                    message = f"‚ùå –ù–æ–º–µ—Ä {action_name} –∑–∞–π–Ω—è—Ç–∏–π. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ —Ö–≤–∏–ª–∏–Ω—É."
                    status = 'busy'
                    logger.warning(f"‚ùå BUSY: {action_name} –∑–∞–π–Ω—è—Ç–æ")
                    
                elif disposition in ['no-answer', 'noanswer'] and duration == 0:
                    # ‚ùå –ù–ï –í–Ü–î–ü–û–í–Ü–î–ê–Ñ
                    message = f"‚ùå –ù–æ–º–µ—Ä {action_name} –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î. –ú–æ–∂–ª–∏–≤–æ –ø—Ä–æ–±–ª–µ–º–∏ –∑–≤'—è–∑–∫—É.\n\n–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –∑–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–π—Ç–µ –Ω–∞–º –∑–∞ –Ω–æ–º–µ—Ä–æ–º <a href=\"tel:+380733103110\">+380733103110</a>"
                    status = 'no_answer'
                    logger.warning(f"‚ùå NO_ANSWER: {action_name} –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î")
                    
                elif disposition == 'answered' and duration > 0:
                    # ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –î–∑–≤—ñ–Ω–æ–∫ –ø—Ä–∏–π–Ω—è–ª–∏ –∑–∞–º—ñ—Å—Ç—å —Å–∫–∏–¥–∞–Ω–Ω—è
                    message = f"‚ö†Ô∏è –î–∑–≤—ñ–Ω–æ–∫ –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è {action_name} –±—É–ª–æ –ø—Ä–∏–π–Ω—è—Ç–æ.\n–ú–æ–∂–ª–∏–≤–æ, —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.\n\n–ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏: <a href=\"tel:+380733103110\">+380733103110</a>"
                    status = 'answered'
                    logger.error(f"‚ö†Ô∏è ANSWERED: –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è - –¥–∑–≤—ñ–Ω–æ–∫ –Ω–∞ {action_name} –ø—Ä–∏–π–Ω—è—Ç–æ (duration: {duration}s)")
                    
                    # –°–ø–æ–≤—ñ—â–∞—î–º–æ –∞–¥–º—ñ–Ω–∞ –ø—Ä–æ –ø—Ä–æ–±–ª–µ–º—É
                    try:
                        from config import ADMIN_USER_ID
                        admin_message = f"üö® –ü–†–û–ë–õ–ï–ú–ê: –î–∑–≤—ñ–Ω–æ–∫ –Ω–∞ {action_name} ({call_data['target_number']}) –±—É–ª–æ –ü–†–ò–ô–ù–Ø–¢–û –∑–∞–º—ñ—Å—Ç—å —Å–∫–∏–¥–∞–Ω–Ω—è! –¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å: {duration}s. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏."
                        send_telegram_message(ADMIN_USER_ID, admin_message)
                    except Exception as admin_error:
                        logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—É: {admin_error}")
                    
                else:
                    # ‚ùå –Ü–ù–®–ê –ü–û–ú–ò–õ–ö–ê
                    message = f"‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–∫—Ä–∏—Ç–∏ {action_name}.\n–°—Ç–∞—Ç—É—Å: {disposition}\n–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å: {duration}s\n\n–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –∑–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–π—Ç–µ –Ω–∞–º –∑–∞ –Ω–æ–º–µ—Ä–æ–º <a href=\"tel:+380733103110\">+380733103110</a>"
                    status = 'failed'
                    logger.warning(f"‚ùå FAILED: {action_name} - {disposition} (duration: {duration}s)")
                
                # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
                success = send_telegram_message(chat_id, message)
                
                if success:
                    logger.info(f"üì§ –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –≤ —á–∞—Ç {chat_id}: {status}")
                else:
                    logger.error(f"‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –≤ —á–∞—Ç {chat_id}")
                
                # –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑—ñ
                call_tracker.update_call_status(call_data['call_id'], status, pbx_call_id)
                
                result = {
                    "success": True, 
                    "status": status, 
                    "message": f"Notification sent to chat {chat_id}",
                    "call_id": call_data['call_id'],
                    "action": action_name
                }
                
            else:
                logger.info(f"‚ÑπÔ∏è –î–∑–≤—ñ–Ω–æ–∫ {pbx_call_id} ({caller_id}) –Ω–µ –≤—ñ–¥—Å—Ç–µ–∂—É—î—Ç—å—Å—è –Ω–∞—à–æ—é —Å–∏—Å—Ç–µ–º–æ—é")
                result = {"success": True, "message": "Call not tracked by our system"}
                
        elif event == 'NOTIFY_START':
            # –î–ª—è –ø–æ—á–∞—Ç–∫—É –¥–∑–≤—ñ–Ω–∫–∞ –º–æ–∂–µ–º–æ –æ–Ω–æ–≤–∏—Ç–∏ PBX call ID —è–∫—â–æ –∑–Ω–∞—Ö–æ–¥–∏–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –¥–∑–≤—ñ–Ω–æ–∫
            logger.info(f"üìû START: PBX ID {pbx_call_id}, Caller: {caller_id}")
            result = {"success": True, "message": "Start event logged"}
            
        elif event == 'NOTIFY_INTERNAL':
            # –õ–æ–≥—É—î–º–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –¥–∑–≤—ñ–Ω–∫–∏
            internal = webhook_data.get('internal', '')
            logger.info(f"üìû INTERNAL: Caller {caller_id} -> Internal {internal}")
            result = {"success": True, "message": "Internal call logged"}
            
        else:
            logger.info(f"‚ÑπÔ∏è –ü–æ–¥—ñ—è {event} –Ω–µ –ø–æ—Ç—Ä–µ–±—É—î –æ–±—Ä–æ–±–∫–∏")
            result = {"success": True, "message": f"Event {event} ignored"}
        
        # –í–∏–≤–æ–¥–∏–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è PHP
        print(json.dumps(result))
        sys.exit(0)
        
    except Exception as e:
        logger.exception(f"‚ùå –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –≤ process_webhook: {e}")
        error_result = {"success": False, "message": str(e)}
        print(json.dumps(error_result))
        sys.exit(1)

if __name__ == "__main__":
    main()