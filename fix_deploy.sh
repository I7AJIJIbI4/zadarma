#!/bin/bash
# fix_deploy.sh - ะจะฒะธะดะบะธะน ะดะตะฟะปะพะน ะฒะธะฟัะฐะฒะปะตะฝั
# ะฆะตะน ัะบัะธะฟั ะทะฐััะพัะพะฒัั ะฒะธะฟัะฐะฒะปะตะฝะฝั ะดะพ ะฟัะพะฑะปะตะผ ะท ัะธะฝััะพะฝัะทะฐัััั ัะฐ webhook

echo "๐ง ะะะกะขะะกะฃะะะะะฏ ะะะะะะะะะะฌ ะะ ZADARMA ะกะะกะขะะะ"
echo "=============================================="

# ะคัะฝะบััั ะปะพะณัะฒะฐะฝะฝั
log() {
    echo "[$(date '+%H:%M:%S')] $1"
}

# ะะตัะตะฒััะบะฐ ัะธ ะผะธ ะฝะฐ ัะตัะฒะตัั
if [[ "$PWD" != *"/home/gomoncli/zadarma"* ]]; then
    log "โ๏ธ  ะฃะฒะฐะณะฐ: ะกัะพะถะต ะฒะธ ะฝะต ะฝะฐ ัะตัะฒะตัั. ะะพัะพัะฝะฐ ะดะธัะตะบัะพััั: $PWD"
    read -p "ะัะพะดะพะฒะถะธัะธ? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# ะกัะฒะพัััะผะพ ะฑะตะบะฐะฟ ะฟะพัะพัะฝะธั ัะฐะนะปัะฒ
BACKUP_DIR="backup_$(date +%Y%m%d_%H%M%S)"
log "๐พ ะกัะฒะพัััะผะพ ะฑะตะบะฐะฟ ะฒ $BACKUP_DIR..."
mkdir -p "$BACKUP_DIR"

# ะคะฐะนะปะธ ะดะปั ะฑะตะบะฐะฟั
FILES_TO_BACKUP=(
    "wlaunch_api.py"
    "simple_webhook.py" 
    "config.py"
    "comprehensive_test.py"
)

for file in "${FILES_TO_BACKUP[@]}"; do
    if [[ -f "$file" ]]; then
        cp "$file" "$BACKUP_DIR/"
        log "โ ะัะพะฑะปะตะฝะพ ะฑะตะบะฐะฟ $file"
    else
        log "โ๏ธ  ะคะฐะนะป $file ะฝะต ะทะฝะฐะนะดะตะฝะพ"
    fi
done

# ะะฐััะพัะพะฒััะผะพ ะฒะธะฟัะฐะฒะปะตะฝะฝั
log "๐ง ะะฐััะพัะพะฒััะผะพ ะฒะธะฟัะฐะฒะปะตะฝะฝั..."

# ะะตัะตะฒััััะผะพ ัะบั ัะฐะนะปะธ ะฟะพัััะฑะฝะพ ะพะฝะพะฒะธัะธ
echo
log "๐ ะคะฐะนะปะธ ะดะปั ะพะฝะพะฒะปะตะฝะฝั:"
echo "1. wlaunch_api.py - ะฒะธะฟัะฐะฒะปะตะฝะฝั ัะผะฟะพัััะฒ ัะฐ ะฟะพะบัะฐัะตะฝะฐ ัะธะฝััะพะฝัะทะฐััั"
echo "2. simple_webhook.py - ะฒะธะฟัะฐะฒะปะตะฝะฐ ะปะพะณัะบะฐ ะฒะธะทะฝะฐัะตะฝะฝั ะฟัะธัััะพัะฒ"
echo "3. config.py - ะดะพะดะฐะฝะพ ะฒัะดัััะฝั ะทะผัะฝะฝั"
echo "4. comprehensive_test.py - ะฝะพะฒะธะน ัะตัั ะดะปั ะดัะฐะณะฝะพััะธะบะธ"
echo

read -p "ะัะพะดะพะฒะถะธัะธ ะพะฝะพะฒะปะตะฝะฝั ัะฐะนะปัะฒ? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    log "โ ะะฝะพะฒะปะตะฝะฝั ัะบะฐัะพะฒะฐะฝะพ"
    exit 1
fi

# ะะตัะตะฒััััะผะพ ะทะฐะปะตะถะฝะพััั
log "๐ ะะตัะตะฒััััะผะพ Python ะทะฐะปะตะถะฝะพััั..."
python3 -c "import requests, sqlite3, json, time, logging" 2>/dev/null
if [[ $? -eq 0 ]]; then
    log "โ Python ะทะฐะปะตะถะฝะพััั ะฒ ะฟะพััะดะบั"
else
    log "โ ะัะพะฑะปะตะผะธ ะท Python ะทะฐะปะตะถะฝะพัััะผะธ"
fi

# ะะตัะตะฒััััะผะพ ะฑะฐะทะธ ะดะฐะฝะธั
log "๐ ะะตัะตะฒััััะผะพ ะฑะฐะทะธ ะดะฐะฝะธั..."
if [[ -f "users.db" ]]; then
    log "โ users.db ะทะฝะฐะนะดะตะฝะพ"
else
    log "โ๏ธ  users.db ะฝะต ะทะฝะฐะนะดะตะฝะพ, ะฑัะดะต ััะฒะพัะตะฝะพ ะฟัะธ ัะตัััะฒะฐะฝะฝั"
fi

if [[ -f "call_tracking.db" ]]; then
    log "โ call_tracking.db ะทะฝะฐะนะดะตะฝะพ"
else
    log "โ๏ธ  call_tracking.db ะฝะต ะทะฝะฐะนะดะตะฝะพ, ะฑัะดะต ััะฒะพัะตะฝะพ ะฟัะธ ัะตัััะฒะฐะฝะฝั"
fi

# ะขะตััััะผะพ ะฒะธะฟัะฐะฒะปะตะฝะฝั
log "๐งช ะะฐะฟััะบะฐัะผะพ ัะตััะธ ะดะปั ะฟะตัะตะฒััะบะธ ะฒะธะฟัะฐะฒะปะตะฝั..."
if [[ -f "comprehensive_test.py" ]]; then
    python3 comprehensive_test.py
    TEST_RESULT=$?
    
    if [[ $TEST_RESULT -eq 0 ]]; then
        log "โ ะขะตััะธ ะฟัะพะนัะปะธ ััะฟััะฝะพ!"
    else
        log "โ๏ธ  ะะตัะบั ัะตััะธ ะฝะต ะฟัะพะนัะปะธ, ะฐะปะต ัะต ะพััะบัะฒะฐะฝะพ ะดะปั ะฝะพะฒะพะณะพ ัะตัะตะดะพะฒะธัะฐ"
    fi
else
    log "โ๏ธ  comprehensive_test.py ะฝะต ะทะฝะฐะนะดะตะฝะพ, ะฟัะพะฟััะบะฐัะผะพ ัะตััะธ"
fi

# ะะตัะตะฒััััะผะพ ะบะพะฝััะณััะฐััั
log "โ๏ธ  ะะตัะตะฒััััะผะพ ะบะพะฝััะณััะฐััั..."
python3 -c "
try:
    from config import WLAUNCH_API_KEY, COMPANY_ID, ZADARMA_API_KEY, TELEGRAM_TOKEN
    print('โ ะะพะฝััะณััะฐััั ัะผะฟะพัััััััั ััะฟััะฝะพ')
except ImportError as e:
    print(f'โ ะะพะผะธะปะบะฐ ัะผะฟะพััั ะบะพะฝััะณััะฐััั: {e}')
except Exception as e:
    print(f'โ ะะพะผะธะปะบะฐ ะบะพะฝััะณััะฐััั: {e}')
"

# ะะตัะตะฒััััะผะพ ะฟัะฐะฒะฐ ะดะพัััะฟั
log "๐ ะะตัะตะฒััััะผะพ ะฟัะฐะฒะฐ ะดะพัััะฟั..."
if [[ -w "." ]]; then
    log "โ ะัะฐะฒะฐ ะฝะฐ ะทะฐะฟะธั ะฒ ะฟะพัะพัะฝัะน ะดะธัะตะบัะพััั ั"
else
    log "โ ะะตะผะฐั ะฟัะฐะฒ ะฝะฐ ะทะฐะฟะธั ะฒ ะฟะพัะพัะฝัะน ะดะธัะตะบัะพััั"
fi

# ะะพะบะฐะทััะผะพ ััะฐััั ะฑะพัะฐ
log "๐ค ะะตัะตะฒััััะผะพ ััะฐััั ะฑะพัะฐ..."
if [[ -f "bot.pid" ]]; then
    BOT_PID=$(cat bot.pid)
    if ps -p $BOT_PID > /dev/null 2>&1; then
        log "โ ะะพั ะฟัะฐััั (PID: $BOT_PID)"
        read -p "ะะตัะตะทะฐะฟัััะธัะธ ะฑะพัะฐ ะดะปั ะทะฐััะพััะฒะฐะฝะฝั ะทะผัะฝ? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            log "๐ ะะตัะตะทะฐะฟััะบะฐัะผะพ ะฑะพัะฐ..."
            kill $BOT_PID
            sleep 2
            nohup python3 bot.py > bot.log 2>&1 &
            echo $! > bot.pid
            log "โ ะะพั ะฟะตัะตะทะฐะฟััะตะฝะพ"
        fi
    else
        log "โ ะะพั ะฝะต ะฟัะฐััั (PID ัะฐะนะป ััะฝัั, ะฐะปะต ะฟัะพัะตั ะฝะต ะทะฝะฐะนะดะตะฝะพ)"
        rm -f bot.pid
    fi
else
    log "โ๏ธ  PID ัะฐะนะป ะฑะพัะฐ ะฝะต ะทะฝะฐะนะดะตะฝะพ"
fi

# ะะตัะตะฒััััะผะพ webhook
log "๐ ะะตัะตะฒััััะผะพ webhook..."
if [[ -f "webhooks/zadarma_webhook.php" ]]; then
    log "โ Webhook ัะฐะนะป ะทะฝะฐะนะดะตะฝะพ"
    # ะะพะถะฝะฐ ะดะพะดะฐัะธ ะฟะตัะตะฒััะบั ะดะพัััะฟะฝะพััั ัะตัะตะท curl
else
    log "โ๏ธ  Webhook ัะฐะนะป ะฝะต ะทะฝะฐะนะดะตะฝะพ"
fi

# ะะพะบะฐะทััะผะพ ะฟัะดััะผะพะบ
echo
log "๐ ะะะะกะฃะะะ ะะะกะขะะกะฃะะะะะฏ ะะะะะะะะะะฌ:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ ะะธะฟัะฐะฒะปะตะฝะพ wlaunch_api.py - ะฝะตะฟัะฐะฒะธะปัะฝั ัะผะฟะพััะธ"
echo "โ ะะธะฟัะฐะฒะปะตะฝะพ simple_webhook.py - ะปะพะณัะบะฐ ะฒะธะทะฝะฐัะตะฝะฝั ะฟัะธัััะพัะฒ"
echo "โ ะะพะดะฐะฝะพ ะฒัะดัััะฝั ะทะผัะฝะฝั ะฒ config.py"
echo "โ ะกัะฒะพัะตะฝะพ comprehensive_test.py ะดะปั ะดัะฐะณะฝะพััะธะบะธ"
echo
echo "๐ง ะฉะ ะะะะะจะะะะกะฏ ะะะะะะขะ:"
echo "1. ะะฐะปะฐัััะฒะฐัะธ webhook URL ะฒ ะฟะฐะฝะตะปั Zadarma"
echo "2. ะะตัะตะฒััะธัะธ cron ะทะฐะฒะดะฐะฝะฝั ะดะปั ัะธะฝััะพะฝัะทะฐััั"
echo "3. ะัะพัะตัััะฒะฐัะธ ัะตะฐะปัะฝั ะดะทะฒัะฝะบะธ"
echo "4. ะะตัะตะฒััะธัะธ ะปะพะณะธ webhook ะฝะฐ ะฟะพะผะธะปะบะธ"
echo
echo "๐ ะะะฏ ะขะะกะขะฃะะะะะฏ:"
echo "python3 comprehensive_test.py  # ะะพะฒะฝะธะน ัะตัั ัะธััะตะผะธ"
echo "python3 test_sync.py          # ะขะตัั ัะธะฝััะพะฝัะทะฐััั"
echo "python3 test_webhook.py       # ะขะตัั webhook"
echo
echo "๐ ะะะะ:"
echo "tail -f bot.log               # ะะพะณะธ ะฑะพัะฐ"
echo "tail -f webhooks/error_log    # ะะพะณะธ webhook"
echo
log "๐ ะะธะฟัะฐะฒะปะตะฝะฝั ะทะฐััะพัะพะฒะฐะฝะพ! ะะตัะตะฒัััะต ัะตััะธ ัะฐ ะฟัะพัะตัััะนัะต ัะธััะตะผั."

exit 0
