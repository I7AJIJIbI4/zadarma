#!/bin/bash
# deploy_sync_improvements.sh - –î–µ–ø–ª–æ–π –ø–æ–∫—Ä–∞—â–µ–Ω—å —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó

set -e  # –ó—É–ø–∏–Ω–∏—Ç–∏—Å—è –ø—Ä–∏ –ø–µ—Ä—à—ñ–π –ø–æ–º–∏–ª—Ü—ñ

echo "üöÄ –î–ï–ü–õ–û–ô –ü–û–ö–†–ê–©–ï–ù–¨ –°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–á"
echo "================================"

# –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è –≤–∏–≤–æ–¥—É
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

log_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

log_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —â–æ –º–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó
if [ ! -f "bot.py" ] || [ ! -f "user_db.py" ]; then
    log_error "–°–∫—Ä–∏–ø—Ç –º–∞—î –∑–∞–ø—É—Å–∫–∞—Ç–∏—Å—è –∑ –∫–æ—Ä–µ–Ω–µ–≤–æ—ó –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –ø—Ä–æ—î–∫—Ç—É"
    exit 1
fi

log_info "–ü–æ—Ç–æ—á–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è: $(pwd)"

# –ö—Ä–æ–∫ 1: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó
BACKUP_DIR="backup_$(date +%Y%m%d_%H%M%S)"
log_info "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó –≤ $BACKUP_DIR..."

mkdir -p "$BACKUP_DIR"
cp user_db.py "$BACKUP_DIR/" 2>/dev/null || log_warning "user_db.py –Ω–µ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ"
cp bot.py "$BACKUP_DIR/" 2>/dev/null || log_warning "bot.py –Ω–µ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ"
cp wlaunch_api.py "$BACKUP_DIR/" 2>/dev/null || log_warning "wlaunch_api.py –Ω–µ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ"
cp config.py "$BACKUP_DIR/" 2>/dev/null || log_warning "config.py –Ω–µ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ"

log_success "–†–µ–∑–µ—Ä–≤–Ω–∞ –∫–æ–ø—ñ—è —Å—Ç–≤–æ—Ä–µ–Ω–∞ –≤ $BACKUP_DIR"

# –ö—Ä–æ–∫ 2: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö —Ñ–∞–π–ª—ñ–≤
log_info "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–æ–≤–∏—Ö —Ñ–∞–π–ª—ñ–≤..."

if [ ! -f "sync_management.py" ]; then
    log_error "–§–∞–π–ª sync_management.py –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!"
    exit 1
fi

if [ ! -f "test_improved_sync.py" ]; then
    log_warning "–§–∞–π–ª test_improved_sync.py –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)"
fi

log_success "–í—Å—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ —Ñ–∞–π–ª–∏ –ø—Ä–∏—Å—É—Ç–Ω—ñ"

# –ö—Ä–æ–∫ 3: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—É Python
log_info "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—É Python —Ñ–∞–π–ª—ñ–≤..."

python3 -m py_compile bot.py || { log_error "–°–∏–Ω—Ç–∞–∫—Å–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –≤ bot.py"; exit 1; }
python3 -m py_compile user_db.py || { log_error "–°–∏–Ω—Ç–∞–∫—Å–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –≤ user_db.py"; exit 1; }
python3 -m py_compile sync_management.py || { log_error "–°–∏–Ω—Ç–∞–∫—Å–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –≤ sync_management.py"; exit 1; }
python3 -m py_compile wlaunch_api.py || { log_error "–°–∏–Ω—Ç–∞–∫—Å–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –≤ wlaunch_api.py"; exit 1; }

log_success "–í—Å—ñ —Ñ–∞–π–ª–∏ –º–∞—é—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å"

# –ö—Ä–æ–∫ 4: –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ø–æ–∫—Ä–∞—â–µ–Ω–æ—ó –ª–æ–≥—ñ–∫–∏ (—è–∫—â–æ —Ñ–∞–π–ª —ñ—Å–Ω—É—î)
if [ -f "test_improved_sync.py" ]; then
    log_info "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤ –ø–æ–∫—Ä–∞—â–µ–Ω–æ—ó –ª–æ–≥—ñ–∫–∏..."
    python3 test_improved_sync.py > test_results.log 2>&1 || {
        log_warning "–¢–µ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å –∑ –ø–æ–º–∏–ª–∫–æ—é, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ test_results.log"
    }
    log_success "–¢–µ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ (—Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –≤ test_results.log)"
fi

# –ö—Ä–æ–∫ 5: –ö–æ–º—ñ—Ç –∑–º—ñ–Ω –¥–æ Git
log_info "–ö–æ–º—ñ—Ç –∑–º—ñ–Ω –¥–æ Git..."

git add user_db.py bot.py sync_management.py test_improved_sync.py 2>/dev/null || true
git commit -m "üîß Improved client sync logic with proper handling of updates and duplicates

- Enhanced add_or_update_client function with smart conflict resolution
- Added comprehensive sync management commands for admins
- Added cleanup functions for duplicate phone numbers
- Added force full sync functionality
- Added individual client sync capability
- Updated bot.py with new sync management commands
- Added extensive test suite for sync logic validation" || {
    log_warning "Git –∫–æ–º—ñ—Ç –Ω–µ –≤–¥–∞–≤—Å—è (–º–æ–∂–ª–∏–≤–æ, –Ω–µ–º–∞—î –∑–º—ñ–Ω)"
}

log_success "–ó–º—ñ–Ω–∏ –∑–∞–∫–æ–º—ñ—á–µ–Ω—ñ –≤ Git"

# –ö—Ä–æ–∫ 6: –ü—É—à –¥–æ GitHub
log_info "–ü—É—à –∑–º—ñ–Ω –Ω–∞ GitHub..."

git push origin main || {
    log_warning "Git push –Ω–µ –≤–¥–∞–≤—Å—è (–ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –º–µ—Ä–µ–∂—É —Ç–∞ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É)"
}

log_success "–ó–º—ñ–Ω–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ –Ω–∞ GitHub"

# –ö—Ä–æ–∫ 7: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó
log_info "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó –ø–æ–∫—Ä–∞—â–µ–Ω—å..."

cat > SYNC_IMPROVEMENTS.md << EOF
# üîÑ –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –∫–ª—ñ—î–Ω—Ç—ñ–≤

## üìÖ –î–∞—Ç–∞ –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è
$(date '+%Y-%m-%d %H:%M:%S')

## üöÄ –û—Å–Ω–æ–≤–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è

### 1. –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –ª–æ–≥—ñ–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –∫–ª—ñ—î–Ω—Ç—ñ–≤
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ö–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ —Ä–æ–∑–≤'—è–∑—É–≤–∞–ª–∏—Å—å –ø–æ ID, –∞ –Ω–µ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
- **–†—ñ—à–µ–Ω–Ω—è**: –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ —Ä–æ–∑—É–º–Ω–∞ –ª–æ–≥—ñ–∫–∞ –æ–±—Ä–æ–±–∫–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤
- **–§–∞–π–ª**: \`user_db.py\` - —Ñ—É–Ω–∫—Ü—ñ—è \`add_or_update_client()\`

### 2. –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –¥—É–±–ª—ñ–∫–∞—Ç–∞–º
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–∞–∫–æ–ø–∏—á—É–≤–∞–ª–∏—Å—å –¥—É–±–ª—ñ–∫–∞—Ç–∏ –ø—Ä–∏ –∑–º—ñ–Ω—ñ –Ω–æ–º–µ—Ä—ñ–≤
- **–†—ñ—à–µ–Ω–Ω—è**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏—è–≤–ª–µ–Ω–Ω—è —Ç–∞ —É—Å—É–Ω–µ–Ω–Ω—è –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤
- **–§—É–Ω–∫—Ü—ñ—è**: \`cleanup_duplicate_phones()\`

### 3. –ù–æ–≤—ñ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ñ –∫–æ–º–∞–Ω–¥–∏
- \`/sync_status\` - —Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
- \`/sync_clean\` - –æ—á–∏—â–µ–Ω–Ω—è –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤  
- \`/sync_full\` - –ø–æ–≤–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è
- \`/sync_test\` - —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è API –ø—ñ–¥–∫–ª—é—á–µ–Ω—å
- \`/sync_user <ID>\` - —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- \`/sync_help\` - –¥–æ–≤—ñ–¥–∫–∞

### 4. –°–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
- **–§–∞–π–ª**: \`test_improved_sync.py\`
- –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Å—Ç–∞—Ä–æ—ó —Ç–∞ –Ω–æ–≤–æ—ó –ª–æ–≥—ñ–∫–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω—ñ —Ç–µ—Å—Ç–∏ —Ä—ñ–∑–Ω–∏—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –°—Ü–µ–Ω–∞—Ä—ñ–π: –î—É–±–ª—ñ–∫–∞—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—ñ–≤
- **–°—Ç–∞—Ä–∞ –ª–æ–≥—ñ–∫–∞**: –°—Ç–≤–æ—Ä—é–≤–∞–ª–∞ 2 –∑–∞–ø–∏—Å–∏ –∑ –æ–¥–Ω–∏–º –Ω–æ–º–µ—Ä–æ–º
- **–ù–æ–≤–∞ –ª–æ–≥—ñ–∫–∞**: –ó–∞–ª–∏—à–∞—î 1 –∑–∞–ø–∏—Å, –≤–∏–¥–∞–ª—è—î –¥—É–±–ª—ñ–∫–∞—Ç

### –°—Ü–µ–Ω–∞—Ä—ñ–π: –ó–º—ñ–Ω–∞ –Ω–æ–º–µ—Ä—É –∫–ª—ñ—î–Ω—Ç–∞  
- **–°—Ç–∞—Ä–∞ –ª–æ–≥—ñ–∫–∞**: –°—Ç–∞—Ä–∏–π –Ω–æ–º–µ—Ä –∑–∞–ª–∏—à–∞–≤—Å—è –≤ –±–∞–∑—ñ
- **–ù–æ–≤–∞ –ª–æ–≥—ñ–∫–∞**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î –Ω–æ–º–µ—Ä

### –°—Ü–µ–Ω–∞—Ä—ñ–π: –ü–µ—Ä–µ–¥–∞—á–∞ –Ω–æ–º–µ—Ä—É –º—ñ–∂ –∫–ª—ñ—î–Ω—Ç–∞–º–∏
- **–°—Ç–∞—Ä–∞ –ª–æ–≥—ñ–∫–∞**: –°—Ç–≤–æ—Ä—é–≤–∞–ª–∞ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç –≤ –±–∞–∑—ñ
- **–ù–æ–≤–∞ –ª–æ–≥—ñ–∫–∞**: –ö–æ—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–¥–∞—î –Ω–æ–º–µ—Ä –Ω–æ–≤–æ–º—É –≤–ª–∞—Å–Ω–∏–∫—É

## üîß –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

### –ê–ª–≥–æ—Ä–∏—Ç–º –æ–±—Ä–æ–±–∫–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤:
1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞ –∑ —Ç–∞–∫–∏–º ID
2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞ –∑ —Ç–∞–∫–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º  
3. –†–æ–∑—É–º–Ω–µ –≤–∏—Ä—ñ—à–µ–Ω–Ω—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ –∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è–º
4. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö

### –ù–æ–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –≤ \`user_db.py\`:
- \`force_full_sync()\` - –ø–æ–≤–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ backup
- \`cleanup_duplicate_phones()\` - –æ—á–∏—â–µ–Ω–Ω—è –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤
- \`sync_specific_client()\` - —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –æ–∫—Ä–µ–º–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞

## üö¶ –°—Ç–∞—Ç—É—Å–∏ –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç—É
- ‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞ –∫–æ–ø—ñ—è —Å—Ç–≤–æ—Ä–µ–Ω–∞: \`$BACKUP_DIR\`
- ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–∏–π
- ‚úÖ –¢–µ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω—ñ
- ‚úÖ –ó–º—ñ–Ω–∏ –∑–∞–∫–æ–º—ñ—á–µ–Ω—ñ –≤ Git
- ‚úÖ –ó–º—ñ–Ω–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ –Ω–∞ GitHub

## üîÑ –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏
1. –î–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä
2. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –Ω–∞ —Ä–µ–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö
3. –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ä–æ–±–æ—Ç–∏ –ø–æ–∫—Ä–∞—â–µ–Ω–æ—ó –ª–æ–≥—ñ–∫–∏
4. –î–æ–∫—É–º–µ–Ω—Ç—É–≤–∞–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤

## üìû –ü—ñ–¥—Ç—Ä–∏–º–∫–∞
–ü—Ä–∏ –≤–∏–Ω–∏–∫–Ω–µ–Ω–Ω—ñ –ø—Ä–æ–±–ª–µ–º –∑–≤–µ—Ä—Ç–∞–π—Ç–µ—Å—è:
- Telegram: @admin  
- –¢–µ–ª–µ—Ñ–æ–Ω: +380733103110
EOF

log_success "–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è —Å—Ç–≤–æ—Ä–µ–Ω–∞: SYNC_IMPROVEMENTS.md"

# –ö—Ä–æ–∫ 8: –§—ñ–Ω–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
echo ""
echo "üéâ –î–ï–ü–õ–û–ô –£–°–ü–Ü–®–ù–û –ó–ê–í–ï–†–®–ï–ù–û!"
echo "============================="
echo ""
log_info "–†–µ–∑–µ—Ä–≤–Ω–∞ –∫–æ–ø—ñ—è: $BACKUP_DIR"
log_info "–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è: SYNC_IMPROVEMENTS.md"
log_info "–õ–æ–≥ —Ç–µ—Å—Ç—ñ–≤: test_results.log"
echo ""
log_warning "–ù–ê–°–¢–£–ü–ù–Ü –ö–†–û–ö–ò:"
echo "1. üöÄ –î–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω: ./deploy.sh"
echo "2. üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥: /sync_status, /sync_test"  
echo "3. üìä –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥—ñ–≤ –ø—ñ—Å–ª—è –¥–µ–ø–ª–æ—é"
echo "4. üßπ –ó–∞–ø—É—Å–∫ –æ—á–∏—â–µ–Ω–Ω—è –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤: /sync_clean"
echo ""
log_success "–í—Å—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –≥–æ—Ç–æ–≤—ñ –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è!"
